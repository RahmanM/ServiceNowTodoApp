<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[function($scope, spUtil) {
  var c = this;
	
	c.categories = [];
	c.todos = [];
	
	// populate the categories so we can fill the drop-down
	// also populate the Todos
	c.loadData = function(){
		c.server.get().then(function(response) {	
			c.categories = response.data.categories;
			c.todos = response.data.todos;
		});
	}
	
	c.loadData();
	
	// Watching the table and updating the scope and consequently the UI with changes
	spUtil.recordWatch($scope, 'x_290424_rahman_to_u_todo', '', function(name, data){
		//debugger;
		// NB: This is also calling the SERVER therefore we need to reset the flags!!
		c.data.updateDb = false;
		c.data.deleteTodo = false;
		spUtil.update($scope);
	});
	
	// Save the actual todo by calling the server
	c.saveTodo = function(){
		// NB: This is a custom flag to be passed to server from client as INPUT
		c.data.updateDb = true;
		
		c.server.update().then(function(response){
				c.data.todo_description = '';
				c.data.category_sys_id = '';
				c.data.is_active = false;
				c.data.updateDb = false;
		});
	}
	
	// Delete todo after user confirms
	c.deleteTodo =  function(todo){
			if(!confirm('Are you sure, you want to delete the record?')){
				 return;
			}
		
			c.data.deleteTodo = true;
			c.data.sys_id = todo.sys_id;
		
			c.server.update().then(function(response){
				c.data.deleteTodo = false;
			});
	}
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>todo_app</id>
        <internal>false</internal>
        <link/>
        <name>Todo App</name>
        <option_schema/>
        <public>true</public>
        <roles/>
        <script><![CDATA[(function() {
	
	/* LOAD DATA ... */
	
	// Get categories only the active ones, limit to 100 and apply sorting
	function getCategories(){
		var sc = new GlideRecord('x_290424_rahman_to_u_todo_category');
		sc.addActiveQuery();
		sc.setLimit(100);
		sc.orderByDesc("category_description");
		sc.query();
		var results = [];
		
		while (sc.next()) {
			if (!$sp.canReadRecord(sc))
				continue;

			var item = {};
			item.category = sc.getDisplayValue('category');
			item.category_description = sc.getDisplayValue('category_description');
			item.sys_id = sc.getUniqueValue('sys_id');				
			results.push(item);
		}
				
		return results;
	}
	
	// Get todos only the active ones, limit to 100 and apply sorting
	function getTodos(){
		var sc = new GlideRecord('x_290424_rahman_to_u_todo');
		sc.addActiveQuery();
		sc.setLimit(100);
		sc.orderByDesc("description");
		sc.query();
		var results = [];
		
		while (sc.next()) {
			if (!$sp.canReadRecord(sc))
				continue;

			var item = {};
			item.description = sc.getDisplayValue('todo_description');
			item.category = sc.getDisplayValue('category');
			item.is_active = sc.getDisplayValue('is_active');
			item.sys_id = sc.getUniqueValue('sys_id');				
			results.push(item);
		}
				
		return results;
	}
	
	this.data.categories = getCategories();
  this.data.todos = getTodos();
	
	/* ACTIONS... */
	
	// Add new todo
	if(input && input.updateDb){
		var gr = new GlideRecord('x_290424_rahman_to_u_todo');
		gr.initialize();
		gr.todo_description =  input.todo_description;
		gr.is_active = input.is_active;
		gr.category = input.category_sys_id;
		gr.insert();

		gs.addInfoMessage("Record added successfuly!");
	}
	
	// Delete todo
	if(input && input.deleteTodo){
		var deleteRecord = new GlideRecord('x_290424_rahman_to_u_todo')
		deleteRecord.addQuery('sys_id', input.sys_id); //to delete one record
		deleteRecord.query();
		deleteRecord.next();
		deleteRecord.deleteRecord();

		gs.addInfoMessage("Record deleted successfuly!");
	}
	
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>rahmanm</sys_created_by>
        <sys_created_on>2018-11-04 11:53:02</sys_created_on>
        <sys_id>748c6f7ddb612300acf39444ca961942</sys_id>
        <sys_mod_count>205</sys_mod_count>
        <sys_name>Todo App</sys_name>
        <sys_package display_value="Rahman_Todo_App" source="x_290424_rahman_to">75158771db212300acf39444ca9619ab</sys_package>
        <sys_policy/>
        <sys_scope display_value="Rahman_Todo_App">75158771db212300acf39444ca9619ab</sys_scope>
        <sys_update_name>sp_widget_748c6f7ddb612300acf39444ca961942</sys_update_name>
        <sys_updated_by>rahmanm</sys_updated_by>
        <sys_updated_on>2018-11-06 22:26:16</sys_updated_on>
        <template><![CDATA[<form class="form-horizontal">
  <div class="form-group">
    <label for="todo-description" class="control-label col-xs-4">Todo Description:</label> 
    <div class="col-xs-8">
      <input id="todo-description" 
             name="todo-description" 
             placeholder="Todo Description" 
             type="text" 
             class="form-control" 
             required="required"
             ng-model="data.todo_description"
             >
    </div>
  </div>
  <div class="form-group">
    <label class="control-label col-xs-4" for="todo-category">Todo Category:</label> 
    <div class="col-xs-8">
      <select 
              id="todo-category" 
              name="todo-category" 
              class="select form-control" 
              required="required"
              ng-model="data.category_sys_id"
              ng-options="category.sys_id as category.category_description for category in data.categories"
              >
        <option value="Travel">Travel</option>
      </select>
    </div>
  </div>
<div class="form-group">
    <div class="col-xs-offset-4 col-sm-10">
      <div class="checkbox">
        <label>
          <input 
                 type="checkbox"
                 ng-model="data.is_active"
                 > Is active?
        </label>
      </div>
    </div>
  </div>
  <div class="form-group row">
    <div class="col-xs-8">
      <button 
              name="submit" 
              type="submit" 
              class="btn btn-primary"
              ng-click="c.saveTodo()"
       >Submit
      </button>
    </div>
  </div>
</form>

<br/>

<div class="table-responsive table-bordered table-striped">
  <table class="table">
    <tr class="">
      	<th>Description</th>
      	<th>Category</th>
      	<th></th>
    </tr>
    <tr class="" ng-repeat="todo in data.todos">
      <td>{{todo.description}}</td>
      <td>{{todo.category}}</td>
      <td>
        <input 
               type="button" 
               value="Delete" 
               ng-click="c.deleteTodo(todo)"
               class="btn btn-danger btn-xs" />
      </td>
    </tr>
  </table>
</div>

<pre>{{data | json}}</pre>
]]></template>
    </sp_widget>
</record_update>
